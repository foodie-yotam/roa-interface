<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ROA - Visual Assistant</title>
    
    <!-- React Flow CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reactflow@11.10.1/dist/style.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
        }

        .main-container {
            display: flex;
            height: 100vh;
        }

        /* Control Panel (Left Side) */
        .control-panel {
            width: 350px;
            background: #1f2937;
            color: white;
            padding: 20px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .header {
            margin-bottom: 20px;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .subtitle {
            font-size: 12px;
            color: #9ca3af;
        }

        .status-box {
            background: #374151;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .status-label {
            font-size: 11px;
            color: #9ca3af;
            margin-bottom: 5px;
        }

        .status-value {
            font-size: 14px;
            color: #10b981;
            font-family: monospace;
        }

        .test-buttons {
            margin-top: 20px;
        }

        .test-buttons h3 {
            font-size: 16px;
            margin-bottom: 12px;
        }

        .test-btn {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            text-align: left;
            transition: all 0.2s;
        }

        .test-btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .test-btn:disabled {
            background: #6b7280;
            cursor: not-allowed;
        }

        .tools-list {
            margin-top: 30px;
            font-size: 12px;
            color: #9ca3af;
        }

        .tools-list h4 {
            margin-bottom: 8px;
        }

        .tools-list ul {
            padding-left: 20px;
            line-height: 1.8;
        }

        /* Visualization Canvas (Right Side) */
        .visualization-canvas {
            flex: 1;
            background: #f3f4f6;
            position: relative;
        }

        #react-flow-container {
            width: 100%;
            height: 100%;
        }

        /* Loading Overlay */
        .loading-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }

        .loading-overlay.active {
            display: flex;
        }

        /* ElevenLabs Widget Container */
        .elevenlabs-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 2000;
        }

        .info-banner {
            background: #374151;
            padding: 12px;
            border-radius: 6px;
            margin-top: auto;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Control Panel -->
        <div class="control-panel">
            <div class="header">
                <h1>üé¨ ROA Visual Assistant</h1>
                <p class="subtitle">Voice + Visual Intelligence</p>
            </div>

            <div class="status-box">
                <div class="status-label">Current Visualization:</div>
                <div class="status-value" id="current-tool">None</div>
            </div>

            <div class="status-box">
                <div class="status-label">Environment:</div>
                <div class="status-value" id="environment">Production</div>
            </div>

            <div class="test-buttons">
                <h3>Test Commands</h3>
                
                <button class="test-btn" onclick="testVisualization('Show me pasta and pizza recipes')">
                    üçù Display Recipes
                </button>
                
                <button class="test-btn" onclick="testVisualization('Multiply the carbonara recipe by 3')">
                    √ó3 Recipe Scaling
                </button>
                
                <button class="test-btn" onclick="testVisualization('Show sales forecast for next month')">
                    üìà Prediction Graph
                </button>
                
                <button class="test-btn" onclick="testVisualization('Low stock alert for tomatoes, only 5 left')">
                    ‚ö†Ô∏è Inventory Alert
                </button>

                <button class="test-btn" onclick="testVisualization('Assign prep vegetables task to Chef Maria')">
                    üë®‚Äçüç≥ Team Assignment
                </button>
            </div>

            <div class="tools-list">
                <h4>Available Visualizations:</h4>
                <ul>
                    <li>display_recipes</li>
                    <li>display_multiplication</li>
                    <li>display_prediction_graph</li>
                    <li>display_inventory_alert</li>
                    <li>display_team_assignment</li>
                </ul>
            </div>

            <div class="info-banner">
                <strong>üí° How to use:</strong><br>
                ‚Ä¢ Click test buttons for quick demos<br>
                ‚Ä¢ Or use ElevenLabs voice widget (bottom-right)<br>
                ‚Ä¢ Speak naturally about recipes, inventory, or team tasks
            </div>
        </div>

        <!-- Visualization Canvas -->
        <div class="visualization-canvas">
            <div class="loading-overlay" id="loading">
                üîÑ Processing...
            </div>
            <div id="react-flow-container"></div>
        </div>
    </div>

    <!-- ElevenLabs Widget -->
    <div class="elevenlabs-container">
        <elevenlabs-convai agent-id="agent_7001k8n6m681et4vpjrg0y8xyfwn"></elevenlabs-convai>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/@elevenlabs/convai-widget-embed" async type="text/javascript"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/reactflow@11.10.1/dist/umd/index.min.js"></script>
    
    <script>
        const { ReactFlow, Background, Controls } = ReactFlowRenderer;
        const SERVER_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:5001' 
            : 'https://roa-voice-production.up.railway.app';

        let reactFlowInstance = null;
        let nodes = [];
        let edges = [];

        // Initialize React Flow
        function initReactFlow() {
            const container = document.getElementById('react-flow-container');
            
            reactFlowInstance = ReactDOM.render(
                React.createElement(ReactFlow, {
                    nodes: [],
                    edges: [],
                    fitView: true,
                    fitViewOptions: { padding: 0.2 }
                }, [
                    React.createElement(Background, { key: 'bg', color: '#d1d5db', gap: 16 }),
                    React.createElement(Controls, { key: 'controls' })
                ]),
                container
            );
        }

        // Visualization renderers
        const visualizationTools = {
            display_recipes: (params) => {
                nodes = params.recipes.map((recipe, idx) => ({
                    id: `recipe-${idx}`,
                    type: 'default',
                    position: { x: 100 + idx * 300, y: 150 },
                    data: { 
                        label: `üçù\n${recipe}\nRecipe Card`
                    },
                    style: {
                        background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
                        color: 'white',
                        border: '3px solid #047857',
                        borderRadius: '12px',
                        width: 200,
                        height: 120,
                        padding: '20px',
                        fontSize: '14px',
                        fontWeight: 'bold',
                        textAlign: 'center'
                    }
                }));
                edges = [];
                updateReactFlow();
            },

            display_multiplication: (params) => {
                nodes = [
                    {
                        id: 'original',
                        position: { x: 50, y: 150 },
                        data: { label: `üçù\n${params.recipe}\nOriginal` },
                        style: { 
                            background: '#3b82f6', 
                            color: 'white', 
                            borderRadius: '10px',
                            padding: '15px',
                            width: 150,
                            textAlign: 'center'
                        }
                    },
                    {
                        id: 'multiply',
                        position: { x: 300, y: 150 },
                        data: { label: `√ó${params.factor}\nMultiply` },
                        style: { 
                            background: '#f59e0b', 
                            color: 'white', 
                            borderRadius: '50%',
                            width: 100,
                            height: 100,
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            fontSize: '18px',
                            fontWeight: 'bold'
                        }
                    },
                    {
                        id: 'result',
                        position: { x: 500, y: 150 },
                        data: { label: `üçù\n${params.recipe}\n√ó${params.factor} servings` },
                        style: { 
                            background: '#10b981', 
                            color: 'white', 
                            borderRadius: '10px',
                            padding: '15px',
                            width: 150,
                            textAlign: 'center'
                        }
                    }
                ];
                
                edges = [
                    { id: 'e1', source: 'original', target: 'multiply', animated: true },
                    { id: 'e2', source: 'multiply', target: 'result', animated: true }
                ];
                updateReactFlow();
            },

            display_prediction_graph: (params) => {
                nodes = Array.from({ length: 5 }, (_, i) => ({
                    id: `point-${i}`,
                    position: { x: 100 + i * 120, y: 180 - i * 15 },
                    data: { label: `$${45 + i * 8}k\nWeek ${i + 1}` },
                    style: { 
                        background: '#8b5cf6', 
                        color: 'white', 
                        borderRadius: '50%',
                        width: 70,
                        height: 70,
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        fontSize: '12px',
                        textAlign: 'center'
                    }
                }));
                
                edges = Array.from({ length: 4 }, (_, i) => ({
                    id: `e${i}`,
                    source: `point-${i}`,
                    target: `point-${i + 1}`,
                    animated: true
                }));
                
                nodes.unshift({
                    id: 'title',
                    position: { x: 200, y: 50 },
                    data: { label: `üìà ${params.metric.toUpperCase()} Forecast` },
                    style: {
                        background: 'transparent',
                        border: 'none',
                        fontSize: '20px',
                        fontWeight: 'bold'
                    }
                });
                
                updateReactFlow();
            },

            display_inventory_alert: (params) => {
                nodes = [{
                    id: 'alert',
                    position: { x: 250, y: 150 },
                    data: { label: `‚ö†Ô∏è\nLow Stock Alert\n${params.item}\n${params.quantity} units left\nREORDER NOW` },
                    style: {
                        background: '#fef3c7',
                        border: '4px solid #f59e0b',
                        borderRadius: '12px',
                        width: 250,
                        height: 250,
                        padding: '30px',
                        fontSize: '16px',
                        textAlign: 'center',
                        fontWeight: 'bold'
                    }
                }];
                edges = [];
                updateReactFlow();
            },

            display_team_assignment: (params) => {
                nodes = [
                    {
                        id: 'task',
                        position: { x: 100, y: 150 },
                        data: { label: `üìã Task\n${params.task}` },
                        style: {
                            background: '#3b82f6',
                            color: 'white',
                            borderRadius: '8px',
                            padding: '15px',
                            width: 180,
                            textAlign: 'center'
                        }
                    },
                    {
                        id: 'assignee',
                        position: { x: 400, y: 150 },
                        data: { label: `üë®‚Äçüç≥ Assigned to\n${params.assignee}` },
                        style: {
                            background: '#10b981',
                            color: 'white',
                            borderRadius: '8px',
                            padding: '15px',
                            width: 180,
                            textAlign: 'center'
                        }
                    }
                ];
                
                edges = [{
                    id: 'assignment',
                    source: 'task',
                    target: 'assignee',
                    animated: true,
                    label: 'assigned'
                }];
                
                updateReactFlow();
            }
        };

        function updateReactFlow() {
            const container = document.getElementById('react-flow-container');
            ReactDOM.render(
                React.createElement(ReactFlow, {
                    nodes: nodes,
                    edges: edges,
                    fitView: true,
                    fitViewOptions: { padding: 0.2 }
                }, [
                    React.createElement(Background, { key: 'bg', color: '#d1d5db', gap: 16 }),
                    React.createElement(Controls, { key: 'controls' })
                ]),
                container
            );
        }

        async function testVisualization(text) {
            const loading = document.getElementById('loading');
            const currentTool = document.getElementById('current-tool');
            
            loading.classList.add('active');
            
            try {
                const response = await fetch(`${SERVER_URL}/api/video-command`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'stage': 'dev'  // Use dev environment for testing
                    },
                    body: JSON.stringify({ text })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to get visualization');
                }
                
                const command = await response.json();
                currentTool.textContent = command.tool;
                
                const visualizer = visualizationTools[command.tool];
                if (visualizer) {
                    visualizer(command.params);
                } else {
                    console.error('Unknown tool:', command.tool);
                    alert('Visualization tool not found: ' + command.tool);
                }
            } catch (err) {
                console.error('Visualization error:', err);
                alert('Error: Could not connect to server. Make sure backend is running.');
            } finally {
                loading.classList.remove('active');
            }
        }

        // Initialize on load
        window.addEventListener('load', () => {
            initReactFlow();
            console.log('‚úÖ Visual ROA initialized');
        });
    </script>
</body>
</html>
